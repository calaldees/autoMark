<!DOCTYPE html><html>
<head>
    <meta charset="utf-8" />
    <link id="favicon" rel="shortcut icon" type="image/png" href="data:image/png;base64,....==" />
    <title>viewer</title>
    <style>
        p {
            margin:0;
            padding:0;
        }
        table {
            border-spacing: 0;
            border-collapse: collapse;
            border:solid #000 !important;
            border-width:1px 0 0 1px !important;
        }
        table td, th {
            /* border: 1px solid black; */
            border:solid #000 !important;
            border-width:0 1px 1px 0 !important;
            vertical-align: top;
        }
    </style>
</head>
<body>
<div id="main"></div>
<script type="module">

const mainElement = document.getElementById('main') || document.getElementsByTagName('body').item(0)

let _data;
window.onhashchange = function() {
    render(_data)
}

function get_weeks(data) {
    if (!data) {data = _data}
    return Array.from(new Set(Object.values(data).map(d=>Object.keys(d)).flat())).sort()
}
function get_tests(data) {
    if (!data) {data = _data}
    console.error('TODO')
    return []
}

function generate_element_table(data) {
    const table = document.createElement('table')

    const weeks = get_weeks()

    function addHeadings() {
        const table_headings = document.createElement('thead')
        table.appendChild(table_headings)
        for (let heading of Array.from(arguments).flat()) {
            const table_heading = document.createElement('th')
            table_headings.appendChild(table_heading)
            table_heading.textContent = heading
        }
    }
    addHeadings('username', weeks)

    for (let [username, week_data] of Object.entries(data)) {
        const table_row = document.createElement('tr')
        table.appendChild(table_row);

        const table_row_name = document.createElement('td')
        table_row.appendChild(table_row_name)
        const username_link = document.createElement('a')
        table_row_name.appendChild(username_link)
        username_link.textContent = username
        username_link.href = `#${username}`

        for (let week of weeks) {
            const table_cell = document.createElement('td')
            table_row.appendChild(table_cell)

            week = week_data[week]
            if (!week) {continue}
            for (let [k,v] of Object.entries(week)) {
                const p = document.createElement('p')
                table_cell.append(p)
                const num_tests = v['@tests'] - v['@skipped']
                const num_pass = num_tests - v['@failures'] - v['@errors']
                p.textContent = `${k.slice(0,2)}: ${num_pass}/${num_tests}`
            }
        }
    }
    return table
}

function generate_element_user(data) {
    const table = document.createElement('table')
    return table
}

function render(data) {
    mainElement.innerHTML = ''
    const hash = window.location.hash.replace('#','') //.split(',').filter((i)=>typeof(i)==="string" && i.length);
    if (hash) {
        mainElement.appendChild(generate_element_user(data[hash]));
    } else {
        mainElement.appendChild(generate_element_table(data));
    }
}


fetch(`data.json`)
    .then(response => response.json())
    .then((data)=>_data=data)
    .then(render)
.catch(err => console.error(err))

</script></body></html>